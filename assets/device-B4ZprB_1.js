import{j as e}from"./index-CGw2APMP.js";const i="showOpenFilePicker"in window&&"showSaveFilePicker"in window,t=new Map,n="cachedFiles",r=()=>{const e=sessionStorage.getItem(n);return e?JSON.parse(e):[]},o=e=>{const i=r();i.includes(e)||(i.push(e),sessionStorage.setItem(n,JSON.stringify(i)))};async function a(){const[e]=await window.showOpenFilePicker({types:[{description:"JSON Files",accept:{"*/*":[".json",".treegridio"]}}]}),i=await e.getFile(),n=i.name;return t.set(n,{file:i,handle:e}),o(n),[i,e,n]}const l=async()=>{if(!i)return new Promise((e,i)=>{const n=document.createElement("input");n.type="file",n.accept=".json,.treegridio",n.onchange=n=>{const r=n.target.files[0];if(r){const i=r.name;t.set(i,{file:r,handle:null}),o(i),e({mode:"D",file:{name:r.name,id:i,rawFile:r}})}else i(new Error("No file picked"))},n.click()});try{const[e,i,t]=await a();return{mode:"D",file:{handle:i,name:e.name,id:t}}}catch(e){if("AbortError"===e.name)throw new Error("File selection was canceled");throw e}};async function s(n){if(!n||"object"!=typeof n||!n.id)throw new Error("Invalid or missing path");let r;const l=t.get(n.id);if(l)r=l.file;else if(i)try{const[e]=await a();r=e}catch(s){throw"AbortError"===s.name?new Error("File selection was canceled"):s}else{if(!n.rawFile)throw{code:404,error:`No data found with filename ${n.id}`};r=n.rawFile,t.set(n.id,{file:r,handle:null}),o(n.id)}try{const i=await r.text();return{content:e(i),path:{...n,fileName:n.id}}}catch(s){throw{code:404,error:`Failed to read or parse file ${n.id}: ${s.message}`}}}async function c(e,n){if(!e||"object"!=typeof e)throw new Error("Invalid or missing data object");if(!n||"object"!=typeof n||!n.fileName)throw new Error("Invalid or missing path");const a=JSON.stringify(e,null,2);if(!i){const e=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=n.fileName,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i);const l=new File([e],n.fileName,{type:"application/json"});return t.set(n.fileName,{file:l,handle:null}),o(n.fileName),{...n,id:n.fileName}}try{const i=t.get(n.fileName),s=null==i?void 0:i.handle;if(!s){const i=r();if(i.includes(n.fileName)||await l(),i.includes(n.fileName))throw new Error(`No file handle available for ${n.fileName}. Cannot overwrite file.`);return c(e,{...n,handle:newFileHandle})}"granted"!==await s.queryPermission({mode:"readwrite"})&&await s.requestPermission({mode:"readwrite"});const d=await s.createWritable();await d.write(a),await d.close();const w=await s.getFile();return t.set(n.fileName,{file:w,handle:s}),o(n.fileName),{...n,id:n.fileName,handle:s}}catch(s){if("AbortError"===s.name)throw new Error("File write permission was denied");throw s}}function d(){return!0}const w="Browser";export{d as authorize,l as pickFile,s as readJsonAttachment,w as type,c as writeObjectToJsonAttachment};

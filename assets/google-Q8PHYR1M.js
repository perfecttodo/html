import{j as e}from"./index-BUZJuguQ.js";async function o(e,o){return new Promise((o,t)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.defer=!0,a.onload=()=>{o()},a.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}let t=null;const a=async e=>{try{const o=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(o.ok){const e=await o.json();return{username:e.name||e.email.split("@")[0],email:e.email}}{const e=await o.json();throw new Error(`Failed to fetch user info: ${e.error.message}`)}}catch(o){return null}};async function i(){if("undefined"==typeof google||!google.accounts.oauth2)try{await o("https://accounts.google.com/gsi/client"),await o("https://apis.google.com/js/api.js")}catch(e){}}async function r(e,o){return await i(),(null==e?void 0:e.accessToken)?e:await(async()=>{let e={};if(await i(),!window.google||!window.google.accounts||!window.google.accounts.oauth2)throw new Error("Google API is not available. Please try again later.");const o=await new Promise((e,o)=>{t=google.accounts.oauth2.initTokenClient({client_id:"111515033736-dffaqu4qg36n2ovfhpaa7qgtndd3u4q2.apps.googleusercontent.com",scope:"https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",callback:async t=>{(null==t?void 0:t.access_token)?e(t):o(new Error("Failed to obtain access token."))},error_callback:e=>{o(e)}}),t.requestAccessToken({prompt:"consent"})});e.accessToken=o.access_token;const r=await a(o.access_token);if(null==r?void 0:r.email)return await n(),e={...e,...r},e;throw new Error("Failed to fetch user information.")})()}const n=async()=>{if("undefined"!=typeof gapi)return new Promise(e=>{gapi.load("picker",{callback:e})})},s=async(e,o)=>{if(!(null==e?void 0:e.accessToken))throw new Error("No access token found. Please sign in again.");if(!o)throw new Error("File or folder ID is required.");const t=await r(e);await(async()=>{if("undefined"!=typeof gapi)return new Promise(e=>{gapi.load("drive-share",{callback:e})})})();try{const e=new gapi.drive.share.ShareClient;return e.setOAuthToken(t.accessToken),e.setItemIds([o]),e.showSettingsDialog(),{success:!0,message:"Share dialog opened successfully."}}catch(a){throw new Error(`Failed to open share dialog: ${a.message}`)}},c=async(e,o)=>{if(!(null==e?void 0:e.accessToken))throw new Error("No access token found. Please sign in again.");if(!o)throw new Error("File or folder ID is required.");const t=await r(e);try{const e=await fetch(`https://www.googleapis.com/drive/v3/files/${o}?fields=webViewLink,permissions&supportsAllDrives=true`,{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(!e.ok){if(401===e.status){t.accessToken=await l();const e=await fetch(`https://www.googleapis.com/drive/v3/files/${o}?fields=webViewLink,permissions&supportsAllDrives=true`,{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(!e.ok){const o=await e.json();throw new Error(`Failed to fetch share link: ${o.error.message}`)}return(await e.json()).webViewLink||null}{const o=await e.json();throw new Error(`Failed to fetch share link: ${o.error.message}`)}}return(await e.json()).webViewLink||null}catch(a){throw new Error(`Failed to fetch share link: ${a.message}`)}},l=async()=>new Promise((e,o)=>{t?t.requestAccessToken({prompt:"",callback:async t=>{if(t&&t.access_token){const o=await a(t.access_token);if(o){userStore.getUserByEmail(o.email)&&userStore.updateUser(o.email,{accessToken:t.access_token})}e(t.access_token)}else o(new Error("Failed to refresh access token"))}}):o(new Error("Token client not initialized"))}),w=async e=>{const o=await r(e);await n();const t=await new Promise((e,t)=>{(new google.picker.PickerBuilder).setOAuthToken(o.accessToken).addView((new google.picker.DocsView).setIncludeFolders(!0).setSelectFolderEnabled(!0).setParent("root")).addView(new google.picker.DocsView(google.picker.ViewId.DOCS).setLabel("Google Drive").setMimeTypes("application/vnd.google-apps.document")).addView(new google.picker.DocsView(google.picker.ViewId.SHAREDADA).setLabel("Shared drives")).addView(new google.picker.DocsView(google.picker.ViewId.RECENTLY_PICKED).setLabel("Recent")).enableFeature(google.picker.Feature.SUPPORT_DRIVES).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setCallback(o=>{o.action===google.picker.Action.PICKED&&e(o.docs[0])}).build().setVisible(!0)});return o.parent=t,o},d=async e=>{await i();const o=await r(e);await n();const t=new google.picker.DocsView(google.picker.ViewId.DOCS).setMimeTypes("application/json").setQuery("*.treegridio");return new Promise((e,a)=>{(new google.picker.PickerBuilder).addView(t).setOAuthToken(o.accessToken).setCallback(t=>{t.action===google.picker.Action.PICKED&&e({...o,file:t.docs[0]})}).build().setVisible(!0)})},p=async(e,o,t)=>{var a;if(!e||"object"!=typeof e)throw new Error("Invalid or missing data object");if(!o||"object"!=typeof o)throw new Error("Invalid path");const i=null==(a=null==o?void 0:o.parent)?void 0:a.id,r=JSON.stringify(e,null,2),n=(null==o?void 0:o.id)&&""!==(null==o?void 0:o.id.trim()),s=n?`https://www.googleapis.com/upload/drive/v3/files/${o.id.trim()}?uploadType=multipart&fields=id&supportsAllDrives=true`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true",c=n?"PATCH":"POST",l=`boundary_${crypto.randomUUID().replace(/-/g,"")}`,w={name:o.fileName,mimeType:"application/json",...n?{}:{parents:i?[i]:[]}},d=btoa(r),p=[`--${l}`,"Content-Type: application/json; charset=UTF-8","",JSON.stringify(w),`--${l}`,"Content-Type: application/json","Content-Transfer-Encoding: base64","",d,`--${l}--`].join("\r\n"),u=await fetch(s,{method:c,headers:{Authorization:`Bearer ${t.accessToken}`,"Content-Type":`multipart/related; boundary=${l}`},body:p});if(!u.ok){const e=await u.json();throw new Error(`Upload failed: ${e.error.message}`)}return await u.json()};async function u(o,t){if(!o||"object"!=typeof o)throw new Error("Invalid path");let a=await(async(e,o)=>{if(!(null==o?void 0:o.accessToken))throw new Error("No access token found. Please sign in again.");if(!(null==e?void 0:e.id))throw new Error("Please select a file to read first.");const t=await fetch(`https://www.googleapis.com/drive/v3/files/${e.id}?fields=id,name,version,modifiedTime,description,lastModifyingUser&supportsAllDrives=true`,{method:"GET",headers:new Headers({Authorization:`Bearer ${o.accessToken}`})});if(!t.ok){const e=await t.json();throw null==e?void 0:e.error}const a=await t.json(),i=await fetch(`https://www.googleapis.com/drive/v3/files/${e.id}?alt=media&supportsAllDrives=true`,{method:"GET",headers:new Headers({Authorization:`Bearer ${o.accessToken}`})});if(i.ok)return{content:await i.text(),metadata:a};const r=await i.json();throw new Error("Error reading file content:",r)})(o,t);return{path:o,content:(null==a?void 0:a.content)?e(a.content):null}}async function g(e,o,t){return await p(e,o,t)}const h=!0,f="GoogleDrive";export{r as authorize,a as fetchUserInfo,c as getShareLink,h as isAuth,s as openShareDialog,d as pickFile,w as pickFolder,u as readJsonAttachment,f as type,p as writeFile,g as writeObjectToJsonAttachment};

import{J as e}from"./index-DG77VZUt.js";const i="showOpenFilePicker"in window&&"showSaveFilePicker"in window,t=new Map;async function a(){const[e]=await window.showOpenFilePicker({types:[{description:"JSON Files",accept:{"*/*":[".json",".treegridio"]}}]}),i=await e.getFile(),a=i.name;return t.set(a,{file:i,handle:e}),[i,e,a]}const n=async e=>{if(!i)return new Promise((e,i)=>{const t=document.createElement("input");t.type="file",t.accept=".json,.treegridio",t.onchange=t=>{const a=t.target.files[0];if(a){const i=a.name;e({mode:"D",file:{name:a.name,id:i,rawFile:a}})}else i(new Error("No file picked"))},t.click()});try{const[i,n,r]=e?await async function(e){const i=await window.showSaveFilePicker({types:[{description:"JSON Files",accept:{"*/*":[".json",".treegridio"]}}],suggestedName:e.fileName}),a=await i.createWritable();await a.write(""),await a.close();const n=await i.getFile(),r=n.name;return t.set(r,{file:n,handle:i}),[n,i,r]}(e):await a();return{mode:"D",file:{handle:n,name:i.name,id:r}}}catch(n){if("AbortError"===n.name)throw new Error("File selection was canceled");throw n}};async function r(n){if(!n||"object"!=typeof n||!n.id)throw new Error("Invalid or missing path");let r;const o=t.get(n.id);if(o)r=o.file;else if(i)try{const[e]=await a();r=e}catch(l){throw"AbortError"===l.name?new Error("File selection was canceled"):l}else{if(!n.rawFile)throw{code:404,error:`No data found with filename ${n.id}`};r=n.rawFile,t.set(n.id,{file:r,handle:null})}try{const i=await r.text();return{content:e.parse(i),path:{...n,fileName:n.id}}}catch(l){throw{code:404,error:`Failed to read or parse file ${n.id}: ${l.message}`}}}async function o(a,r){if(!a||"object"!=typeof a)throw new Error("Invalid or missing data object");if(!r||"object"!=typeof r||!r.fileName)throw new Error("Invalid or missing path");const o=e.stringify(a,null,2);if(!i){const e=new Blob([o],{type:"application/json"}),i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=r.fileName,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i);const n=new File([e],r.fileName,{type:"application/json"});return t.set(r.fileName,{file:n,handle:null}),saveFileToSessionStorage(r.fileName),{...r,id:r.fileName}}try{const e=t.get(r.fileName);let i=null==e?void 0:e.handle;if(!i){const e=await n(r);if(!e)throw new Error(`No file handle available for ${r.fileName}. Cannot overwrite file.`);i=e.file.handle}"granted"!==await i.queryPermission({mode:"readwrite"})&&await i.requestPermission({mode:"readwrite"});const a=await i.createWritable();await a.write(o),await a.close();const l=await i.getFile();return t.set(r.fileName,{file:l,handle:i}),{...r,id:r.fileName,handle:i}}catch(l){if("AbortError"===l.name)throw new Error("File write permission was denied");throw l}}function l(){return!0}const c="Device";export{l as authorize,n as pickFile,r as readJsonAttachment,c as type,o as writeObjectToJsonAttachment};

import{j as e}from"./index-DU-BM5Z3.js";async function o(e,o){return new Promise((o,t)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.defer=!0,r.onload=()=>{o()},r.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(r)})}for(var t={byteLength:function(e){var o=c(e),t=o[0],r=o[1];return 3*(t+r)/4-r},toByteArray:function(e){var o,t,r=c(e),i=r[0],s=r[1],l=new n(function(e,o,t){return 3*(o+t)/4-t}(0,i,s)),d=0,w=s>0?i-4:i;for(t=0;t<w;t+=4)o=a[e.charCodeAt(t)]<<18|a[e.charCodeAt(t+1)]<<12|a[e.charCodeAt(t+2)]<<6|a[e.charCodeAt(t+3)],l[d++]=o>>16&255,l[d++]=o>>8&255,l[d++]=255&o;2===s&&(o=a[e.charCodeAt(t)]<<2|a[e.charCodeAt(t+1)]>>4,l[d++]=255&o);1===s&&(o=a[e.charCodeAt(t)]<<10|a[e.charCodeAt(t+1)]<<4|a[e.charCodeAt(t+2)]>>2,l[d++]=o>>8&255,l[d++]=255&o);return l},fromByteArray:function(e){for(var o,t=e.length,a=t%3,n=[],i=16383,s=0,c=t-a;s<c;s+=i)n.push(d(e,s,s+i>c?c:s+i));1===a?(o=e[t-1],n.push(r[o>>2]+r[o<<4&63]+"==")):2===a&&(o=(e[t-2]<<8)+e[t-1],n.push(r[o>>10]+r[o>>4&63]+r[o<<2&63]+"="));return n.join("")}},r=[],a=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)r[s]=i[s],a[i.charCodeAt(s)]=s;function c(e){var o=e.length;if(o%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=e.indexOf("=");return-1===t&&(t=o),[t,t===o?0:4-t%4]}function l(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function d(e,o,t){for(var r,a=[],n=o;n<t;n+=3)r=(e[n]<<16&16711680)+(e[n+1]<<8&65280)+(255&e[n+2]),a.push(l(r));return a.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63;let w=null;const u=async e=>{try{const o=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(o.ok){const e=await o.json();return{username:e.name||e.email.split("@")[0],email:e.email}}{const e=await o.json();throw new Error(`Failed to fetch user info: ${e.error.message}`)}}catch(o){return null}};async function p(){if("undefined"==typeof google||!google.accounts.oauth2)try{await o("https://accounts.google.com/gsi/client"),await o("https://apis.google.com/js/api.js")}catch(e){}}async function g(e,o){return await p(),(null==e?void 0:e.accessToken)?e:await(async()=>{let e={};if(await p(),!window.google||!window.google.accounts||!window.google.accounts.oauth2)throw new Error("Google API is not available. Please try again later.");const o=await new Promise((e,o)=>{w=google.accounts.oauth2.initTokenClient({client_id:"111515033736-dffaqu4qg36n2ovfhpaa7qgtndd3u4q2.apps.googleusercontent.com",scope:"https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",callback:async t=>{(null==t?void 0:t.access_token)?e(t):o(new Error("Failed to obtain access token."))},error_callback:e=>{o(e)}}),w.requestAccessToken({prompt:"consent"})});e.accessToken=o.access_token;const t=await u(o.access_token);if(null==t?void 0:t.email)return await h(),e={...e,...t},e;throw new Error("Failed to fetch user information.")})()}const h=async()=>{if("undefined"!=typeof gapi)return new Promise(e=>{gapi.load("picker",{callback:e})})},f=async(e,o)=>{if(!(null==e?void 0:e.accessToken))throw new Error("No access token found. Please sign in again.");if(!o)throw new Error("File or folder ID is required.");const t=await g(e);await(async()=>{if("undefined"!=typeof gapi)return new Promise(e=>{gapi.load("drive-share",{callback:e})})})();try{const e=new gapi.drive.share.ShareClient;return e.setOAuthToken(t.accessToken),e.setItemIds([o]),e.showSettingsDialog(),{success:!0,message:"Share dialog opened successfully."}}catch(r){throw new Error(`Failed to open share dialog: ${r.message}`)}},m=async(e,o)=>{if(!(null==e?void 0:e.accessToken))throw new Error("No access token found. Please sign in again.");if(!o)throw new Error("File or folder ID is required.");const t=await g(e);try{const e=await fetch(`https://www.googleapis.com/drive/v3/files/${o}?fields=webViewLink,permissions&supportsAllDrives=true`,{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(!e.ok){if(401===e.status){t.accessToken=await k();const e=await fetch(`https://www.googleapis.com/drive/v3/files/${o}?fields=webViewLink,permissions&supportsAllDrives=true`,{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(!e.ok){const o=await e.json();throw new Error(`Failed to fetch share link: ${o.error.message}`)}return(await e.json()).webViewLink||null}{const o=await e.json();throw new Error(`Failed to fetch share link: ${o.error.message}`)}}return(await e.json()).webViewLink||null}catch(r){throw new Error(`Failed to fetch share link: ${r.message}`)}},k=async()=>new Promise((e,o)=>{w?w.requestAccessToken({prompt:"",callback:async t=>{if(t&&t.access_token){const o=await u(t.access_token);if(o){userStore.getUserByEmail(o.email)&&userStore.updateUser(o.email,{accessToken:t.access_token})}e(t.access_token)}else o(new Error("Failed to refresh access token"))}}):o(new Error("Token client not initialized"))}),y=async e=>{const o=await g(e);await h();const t=await new Promise((e,t)=>{(new google.picker.PickerBuilder).setOAuthToken(o.accessToken).addView((new google.picker.DocsView).setIncludeFolders(!0).setSelectFolderEnabled(!0).setParent("root")).addView(new google.picker.DocsView(google.picker.ViewId.DOCS).setLabel("Google Drive").setMimeTypes("application/vnd.google-apps.document")).addView(new google.picker.DocsView(google.picker.ViewId.SHAREDADA).setLabel("Shared drives")).addView(new google.picker.DocsView(google.picker.ViewId.RECENTLY_PICKED).setLabel("Recent")).enableFeature(google.picker.Feature.SUPPORT_DRIVES).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setCallback(o=>{o.action===google.picker.Action.PICKED&&e(o.docs[0])}).build().setVisible(!0)});return o.parent=t,o},v=async e=>{await p();const o=await g(e);await h();const t=new google.picker.DocsView(google.picker.ViewId.DOCS).setMimeTypes("application/json").setQuery("*.treegridio");return new Promise((e,r)=>{(new google.picker.PickerBuilder).addView(t).setOAuthToken(o.accessToken).setCallback(t=>{t.action===google.picker.Action.PICKED&&e({...o,file:t.docs[0]})}).build().setVisible(!0)})},T=async(e,o,r)=>{var a;if(!e||"object"!=typeof e)throw new Error("Invalid or missing data object");if(!o||"object"!=typeof o)throw new Error("Invalid path");const n=null==(a=null==o?void 0:o.parent)?void 0:a.id,i=JSON.stringify(e,null,2),s=(null==o?void 0:o.id)&&""!==(null==o?void 0:o.id.trim()),c=s?`https://www.googleapis.com/upload/drive/v3/files/${o.id.trim()}?uploadType=multipart&fields=id&supportsAllDrives=true`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true",l=s?"PATCH":"POST",d=`boundary_${crypto.randomUUID().replace(/-/g,"")}`,w={name:o.fileName,mimeType:"application/json",...s?{}:{parents:n?[n]:[]}},u=function(e){try{return"string"==typeof e&&(e=(new TextEncoder).encode(e)),t.fromByteArray(e)}catch(o){throw o}}(i),p=[`--${d}`,"Content-Type: application/json; charset=UTF-8","",JSON.stringify(w),`--${d}`,"Content-Type: application/json","Content-Transfer-Encoding: base64","",u,`--${d}--`].join("\r\n"),g=await fetch(c,{method:l,headers:{Authorization:`Bearer ${r.accessToken}`,"Content-Type":`multipart/related; boundary=${d}`},body:p});if(!g.ok){const e=await g.json();throw new Error(`Upload failed: ${e.error.message}`)}return await g.json()};async function A(o,t){var r;if(!o||"object"!=typeof o)throw new Error("Invalid path");let a=await(async(e,o)=>{if(!(null==o?void 0:o.accessToken))throw"No access token found. Please sign in again.";if(!(null==e?void 0:e.id))throw new Error("Please select a file to read first.");const t=await fetch(`https://www.googleapis.com/drive/v3/files/${e.id}?fields=id,name,version,modifiedTime,description,lastModifyingUser&supportsAllDrives=true`,{method:"GET",headers:new Headers({Authorization:`Bearer ${o.accessToken}`})});if(!t.ok){const e=await t.json();throw null==e?void 0:e.error}const r=await t.json(),a=await fetch(`https://www.googleapis.com/drive/v3/files/${e.id}?alt=media&supportsAllDrives=true`,{method:"GET",headers:new Headers({Authorization:`Bearer ${o.accessToken}`})});if(a.ok)return{content:await a.text(),metadata:r};const n=await a.json();throw new Error("Error reading file content:",n)})(o,t),n=(null==a?void 0:a.content)?e(a.content):null,i=null==(r=null==a?void 0:a.metadata)?void 0:r.name;return{path:{...o,fileName:i},content:n}}async function E(e,o,t){return await T(e,o,t)}const b=!0,C="GoogleDrive";export{g as authorize,u as fetchUserInfo,m as getShareLink,b as isAuth,f as openShareDialog,v as pickFile,y as pickFolder,A as readJsonAttachment,C as type,T as writeFile,E as writeObjectToJsonAttachment};
